---
- name: install homebrew
  # NOTE: output is redirected to /dev/null since homebrew will prompt if stdin is not a TTY
  shell: /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" </dev/null
  args:
    creates: /usr/local/bin/brew

- name: ensure homebrew is updated 
  homebrew:
    state: latest
    update_homebrew: yes

- name: install node
  homebrew:
    name: node
    state: present

- name: synchronize source folder
  synchronize:
    src: "{{ role_path }}/../../"
    dest: ~/frontend

- name: install node modules
  command: npm install

- name: build production javascript/html/css bundles
  command: npm run build:production

- name: sync backup to s3
  command: aws s3 cp ~/mysql_backup_{{ backup_timestamp }}.sql.tgz s3://{{ aws_public_bucket }} --force --acl public-read
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws_public_access_key_id }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws_public_secret_access_key }}"
